---
kind: Pipeline
name: setup
runtime: kubernetes
segments:
  - name: echo
    kind: Script
    command: echo "Running echo for {environment.name}"
  - name: eksctl
    kind: eksctl
    command: "get nodegroups --cluster {environment.config['cluster']} -o json"
  - name: IstioInstaller
    kind: Script
    commands:
      - istioctl manifest generate --set values.kiali.enabled=true --set values.global.mtls.enabled=false --set values.global.controlPlaneSecurityEnabled=true
      - istioctl operator init
  - name: monitoring
    template: templates/monitoring.yaml
    kind: KubernetesManifest
    action: get
